<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR-video con sonido (fix iOS + alineación)</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- Gestos pinch / rotate -->
  <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
  <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

  <script>
    AFRAME.registerComponent('videohandler', {
      init () {
        const marker  = this.el;
        const vid     = document.querySelector('#vid');
        const overlay = document.getElementById('overlay');
        let tapDone   = false;
        let markerOn  = false;

        // Iniciar el video muted y reproducirlo para que iOS desbloquee el frame
        vid.muted = true;
        vid.play().catch(() => {});

        const unlock = () => {
          tapDone = true;
          overlay.style.display = 'none';
          if (markerOn) {
            vid.muted = false;
            vid.play().catch(()=>{});
          }
          window.removeEventListener('click', unlock);
          window.removeEventListener('touchend', unlock);
        };

        window.addEventListener('click', unlock);
        window.addEventListener('touchend', unlock);

        marker.addEventListener('markerFound', () => {
          markerOn = true;
          if (tapDone) {
            vid.muted = false;
            vid.play().catch(()=>{});
          }
        });

        marker.addEventListener('markerLost', () => {
          markerOn = false;
          vid.pause();
        });
      }
    });
  </script>

  <style>
    #overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:transparent;
      color:#fff; font-family:sans-serif; font-size:1.25rem;
      text-shadow:0 0 6px #000;
      z-index:999; text-align:center; padding:1rem;
    }
  </style>
</head>

<body style="margin:0; overflow:hidden;">
  <div id="overlay">Toca la pantalla para activar el audio ▶️</div>

  <a-scene
    vr-mode-ui="enabled:false"
    loading-screen="enabled:false"
    arjs="sourceType:webcam;debugUIEnabled:false"
    embedded
    gesture-detector>

    <a-assets>
      <video id="vid"
             src="assets/asset.mp4"
             preload="auto"
             loop
             crossorigin="anonymous"
             playsinline
             webkit-playsinline
             muted></video>
    </a-assets>

    <a-marker type="pattern"
              preset="custom"
              url="assets/marker.patt"
              videohandler
              smooth="true"
              smoothCount="10"
              smoothTolerance="0.01"
              smoothThreshold="5"
              emitevents="true">

      <!-- Envolver el video en un entity para alinear y escalar más consistente -->
      <a-entity position="0 0 0" rotation="-90 0 0">
        <a-video src="#vid"
                 width="1"
                 height="0.5625"
                 position="0 0 0"
                 class="clickable"
                 gesture-handler>
        </a-video>
      </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
