<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR-video con sonido (fix iOS + proporci칩n + zoom)</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- Gestos pinch / rotate -->
  <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
  <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

  <script>
    /* 游댳 Forzar c치mara trasera normal sin zoom */
    const origGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
    navigator.mediaDevices.getUserMedia = (constraints) => {
      if (constraints.video) {
        constraints.video = {
          facingMode: { ideal: "environment" }, // c치mara trasera normal
          width: { ideal: 640 },
          height: { ideal: 480 },
          aspectRatio: { ideal: 4/3 }
        };
      }
      return origGetUserMedia(constraints);
    };

    /* 游댳 Componente para manejar video y audio */
    AFRAME.registerComponent('videohandler', {
      init () {
        const marker  = this.el;
        const vid     = document.querySelector('#vid');
        const overlay = document.getElementById('overlay');
        let tapDone   = false;
        let markerOn  = false;

        // Arrancar muted para evitar cuadro negro en iOS
        vid.muted = true;
        vid.play().catch(() => {});

        const unlock = () => {
          tapDone = true;
          overlay.style.display = 'none';
          if (markerOn) {
            vid.muted = false;
            vid.play().catch(()=>{});
          }
          window.removeEventListener('click', unlock);
          window.removeEventListener('touchend', unlock);
        };

        window.addEventListener('click', unlock);
        window.addEventListener('touchend', unlock);

        marker.addEventListener('markerFound', () => {
          markerOn = true;
          if (tapDone) {
            vid.muted = false;
            vid.play().catch(()=>{});
          }
        });

        marker.addEventListener('markerLost', () => {
          markerOn = false;
          vid.pause();
        });
      }
    });
  </script>

  <style>
    #overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:transparent;
      color:#fff; font-family:sans-serif; font-size:1.25rem;
      text-shadow:0 0 6px #000;
      z-index:999; text-align:center; padding:1rem;
    }
  </style>
</head>

<body style="margin:0; overflow:hidden;">
  <!-- Overlay para activar audio -->
  <div id="overlay">Toca la pantalla para activar el audio 郊윒잺</div>

  <!-- Escena -->
  <a-scene
    vr-mode-ui="enabled:false"
    loading-screen="enabled:false"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    embedded
    gesture-detector>

    <a-assets>
      <video id="vid"
             src="assets/asset.mp4"
             preload="auto"
             loop
             crossorigin="anonymous"
             playsinline
             webkit-playsinline
             muted></video>
    </a-assets>

    <a-marker type="pattern"
              preset="custom"
              url="assets/marker.patt"
              videohandler
              smooth="true"
              smoothCount="10"
              smoothTolerance="0.01"
              smoothThreshold="5"
              emitevents="true">

      <!-- Mantener escala y proporci칩n como en tu c칩digo original -->
      <a-video src="#vid"
               scale="1 1 1"
               position="0 0.1 0"
               rotation="-90 0 0"
               class="clickable"
               gesture-handler>
      </a-video>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
