<script>
  AFRAME.registerComponent('videohandler', {
    init () {
      const marker  = this.el;
      const vid     = document.querySelector('#vid');
      const overlay = document.getElementById('overlay');
      const videoEl = marker.querySelector('a-video');
      let tapDone   = false;
      let markerOn  = false;
      let calibrado = false;

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

      if (isIOS) {
        vid.setAttribute('muted', 'true');
        vid.setAttribute('playsinline', 'true');
        vid.setAttribute('webkit-playsinline', 'true');
        vid.muted = true;
        vid.load();
      }

      const unlock = () => {
        tapDone = true;
        overlay.style.display = 'none';
        tryPlay();
        window.removeEventListener('click',  unlock);
        window.removeEventListener('touchend', unlock);
      };
      window.addEventListener('click',  unlock);
      window.addEventListener('touchend', unlock);

      marker.addEventListener('markerFound', () => {
        markerOn = true;
        tryPlay();

        // Calibrar posición una sola vez por detección
        if (!calibrado) {
          setTimeout(() => {
            videoEl.setAttribute('position', '0 0 0'); // Centrado
            videoEl.setAttribute('rotation', '-90 0 0'); // Plano sobre marcador
            calibrado = true;
          }, 500); // espera medio segundo para que el tracking se estabilice
        }
      });

      marker.addEventListener('markerLost', () => {
        markerOn = false;
        vid.pause();
        calibrado = false;
      });

      function tryPlay () {
        if (tapDone && markerOn) {
          if (isIOS) {
            vid.muted = true;
            vid.play().then(() => {
              setTimeout(() => {
                vid.muted = false;
              }, 100);
            }).catch(() => {});
          } else {
            vid.muted = false;
            vid.play().catch(() => {});
          }
        }
      }
    }
  });
</script>
